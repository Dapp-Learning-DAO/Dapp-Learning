PSBT（Partially Signed Bitcoin Transaction，部分签名比特币交易）是一种交易格式，用于在不同参与者之间安全地传输未完成的交易信息，以便完成签名过程。这种格式主要用于提高比特币交易的灵活性和多方合作的安全性，尤其是在涉及多重签名和复杂的交易结构时。

### PSBT的目的和应用场景

PSBT（Partially Signed Bitcoin Transactions）是一种格式，用于Bitcoin交易的离线或多方签名。这种格式在[BIP 174](https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki)中被详细定义，该BIP是由Andrew Chow于2017年提出的，PSBT编码和解析参考[PSBT encode](./encode.md)。

在PSBT出现之前，Bitcoin的交易签名过程通常需要交易的所有参与者在线，并能够直接交互以产生完全签名的交易。这在多方需要合作创建一个交易，尤其是在使用硬件钱包或冷存储方案时，会变得复杂和不安全。此外，对于复杂的交易类型（如多重签名或条件交易），简单的交易签名数据结构并不足以容纳所需的全部信息，如前一交易的脚本或其他元数据。

PSBT的设计初衷是解决比特币生态中的一个关键问题：在不共享私钥的情况下，如何在多个参与者之间安全地协作构建和签名交易。它允许每个参与者独立地添加到交易的签名或其他必需信息，而不必暴露自己的私钥给其他人。

主要应用场景包括：
- **多重签名交易**：多个参与者需要对同一笔交易进行签名。
- **冷存储和硬件钱包**：安全设备可以在不直接连接到互联网的情况下签名交易。
- **复杂的交易类型**：涉及时间锁、多步骤执行等特殊条件的交易。

## PSBT的工作原理
在PSBT（Partially Signed Bitcoin Transaction）的工作流程中，涉及到几个关键的参与者或身份，他们各自负责交易的不同阶段。这些身份通常根据他们在交易签名和构建过程中的角色来定义。以下是PSBT流程中几个主要身份的概述：

### 1. 交易发起者（Creator）
- **角色**：开始PSBT流程的是交易发起者。他们负责构建交易的初始结构，这包括定义交易的输入和输出。
- **责任**：交易发起者需要收集并添加所有必要的输入数据（如UTXOs的详细信息）以及输出信息。他们会创建一个PSBT文件，此文件还未包含任何签名。

### 2. 更新者（Updater）
- **角色**：更新者的任务是添加或更新交易中缺失的信息，这可能包括输入和输出的附加细节。
- **责任**：更新者确保PSBT包含足够的信息以便所有参与者可以验证交易。例如，他们可能需要添加redeemScript或witnessScript等信息。

### 3. 签名者（Signer）
- **角色**：签名者是那些用自己的私钥对交易的一个或多个输入进行签名的参与者。
- **责任**：每个签名者都必须独立验证他们即将签名的交易的有效性和完整性。在确认无误后，签名者将他们的签名添加到PSBT中。

### 4. 合并者（Combiner）
- **角色**：在多签名或多步骤签名的情况下，合并者负责将来自不同签名者的多个PSBT副本合并成一个包含所有必需签名的单一PSBT。
- **责任**：合并者需确保所有的签名都正确并被妥善地合并到PSBT中，没有遗漏任何有效签名。

### 5. 最终化者（Finalizer）
- **角色**：最终化者负责处理交易的最终细节，确保所有的输入都已正确地签名，并将PSBT转换成可以广播的标准比特币交易格式。
- **责任**：最终化者将完成的签名脚本插入到交易中的相应输入，并移除所有不再需要的临时数据。

### 6. 广播者（Broadcaster）
- **角色**：一旦PSBT被最终化并转换成一个完整的交易后，广播者负责将其发送到比特币网络。
- **责任**：广播者需要确保交易被网络接受，并进行监控，直到交易被确认。

## PSBT与普通交易的联系与区别

| 特性           | 普通交易 (Raw Transaction)       | PSBT (Partially Signed Bitcoin Transaction)    |
|---------------|-----------------------------------|------------------------------------------------|
| **格式**      | 简单的二进制格式                  | 扩展的二进制格式，包含未签名交易和元数据      |
| **用途**      | 直接在网络上广播和确认            | 用于离线或多方签名，最终转换为普通交易广播    |
| **签名**      | 交易中直接包含签名                | 签名被包含在元数据中，允许多步骤和多方签名    |
| **数据内容**  | 仅包含交易必需的数据              | 包含交易数据外的额外信息，如脚本、公钥等      |
| **交互性**    | 通常由单一实体完成                | 支持多个实体分别签名后合并                    |
| **安全性**    | 需要网络连接进行签名              | 可以完全离线签名，提高安全性                  |
| **兼容性**    | 所有比特币网络节点直接支持        | 需要特定的钱包或工具来创建和解析PSBT          |
| **处理流程**  | 创建、签名、广播为一体的流程      | 创建、签名可以分开，由不同的参与者在不同时间完成 |
| **适用场景**  | 简单的个人交易                    | 复杂的交易，如多重签名、企业级应用等          |



PSBT是一个强大的工具，能够处理复杂的比特币交易，特别是在需要多方合作的情况下。它通过提供一个标准化且安全的方式来协调和合并不同参与者的输入，极大地增强了比特币交易的多样性和安全性。每个角色在PSBT的创建和完成过程中发挥着关键作用，确保交易不仅符合技术规范，同时也达到了预期的安全性标准。