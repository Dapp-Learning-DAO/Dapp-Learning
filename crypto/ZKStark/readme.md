# ZK-STARK

## 知识回顾：FFT
zkstark和FFT的思路类似，均采用了分治的思想，使得时间复杂度变为O(NlogN)。这里先回顾下FFT的知识。

FFT用于求解这么一个问题：给定一个某个域上的多项式f(x)，还有一组输入D(也就是横坐标)，求这组输入对应的纵坐标。通过分治法，FFT的性能上可以比朴素做法高出一个数量级。本文重点讲解正变换的原理，因为它和ZKSTARK的FRI协议思路很相像。

此外，FFT还有一个逆变换IFFT，给定一组点值，求多项式，功能类似于插值法。本文不讨论它的实现。


### FFT的输入
FFT对输入数据有要求，它们必须构成一个循环群，而且群的阶必须是2的幂，例如2，4，8，16...。

现在考虑这样一个4阶的循环群，其中生成元是g:
$\{g^0, g^1, g^2, g^3\}$

如果我们把每个元素的都做一次幂操作：
- $(g^0)^2 = g^0$
- $(g^1)^2 = g^2$
- $(g^2)^2 = g^4 = g^0$
- $(g^3)^2 = g^6 = g^2$

做这样的幂操作，会恰好得到2个元素：${g^0, g^2}$. 同样，如果我们把这个2阶的元素继续做幂操作，会得到唯一的元素$g^0$.

现在，假设有一个阶为$2^n$的循环群: $\{g^0, g^1, g^2, ..,g^i, .., g^{2^n-1}\}$

如果对每个元素做上述幂操作，得到：
$\{g^0, g^2, g^4, ..,g^{2i}, .., g^{2^{n+1}-2}\}$
这个集合中，独特的元素只有一半个，即$2^{n-1}$个。

为了理解这一点，可以把原始集合分解成数量相等的前后两段，分别考察：
- 前半段$\{g^0, g^1, .., g^{2^{n-1}-1}\}$
- 后半段$\{g^{2^{n-1}}, g^{2^{n-1}+1}, .., g^{2^n-1}\}$

前半段和后半段分别取第一个元素求幂，一个得到$g^0$,一个得到$g^{2^n}=g^0$；分别取第二个元素求幂，也相等，均等于$g^2$。也就是说，通过对原始循环群的每个元素求幂，得到的新的集合，它相当于循环群前半段的各元素求幂。也就是说，所得集合，相当于从原循环群里从第1个元素$g^0$开始，每隔1个元素取一个，所得就是取幂后的新集合。

接下来看得到的这个新的集合，它也构成一个循环子群，它的元素数目为$2^{n-1}$，也是2的幂。它的每个元素，可以通过生成元$g^2$得到。所以，我们可以将它继续求幂，得到容量为原始循环子群四分之一的循环子群,...，直到得到1阶的循环子群：$\{g^0\}$。

再考察一个具体的例子：

假设有一个模13乘法群$\{0, 1, 2, 3, ,..12\}$，我们取8作为生成元，取8的所有的幂，发现只有4个可能的值：$\{1, 8, 12, 5\}$，它构成一个循环子群，这个循环子群的阶为4，也就意味着可以通过求幂得到：$\{8^0, 8^2, 8^4, 8^6\}$ = $\{1,  12, 1, 12\}$，即循环子群$\{1，12\}$；进一步求幂，得到$\{1\}$。


理解了这个性质，谁理解FFT的一大关键。

### FFT变换过程
现在来通过一个例子看FFT变换的原理。

假设有一个多项式$f(x)=3x^5 + 7x^4 + x^3 + 2x^2 + 3x + 6$，它构建在模13乘法群$\{0, 1, 2, 3, ,..12\}$上。给定输入集合：$\{1, 8, 12, 5\}$。注意，这个集合实际上是通过8生成的循环子群，容量为2的某个幂，意味着可以通过对每个元素求幂（从第一个元素开始，每隔1个元素取一个）的方式，得到一个容量减半的循环子群，直到得到集合$\{1\}。这个过程我们这里简称为“**求幂分解**”

接下来我们来处理多项式f(x).

如果按照传统做法，我们要把每个输入元素带入多项式，得到多项式的解。如果采用FFT的做法，会先把f(x)，提取出幂为偶数的部分：

$even(x) = 7x^4 + 2x^2 + 6$

如果我们把$x^2$看成一个整体，那么可以简化为
$even(x) = 7x^2 + 2x + 6$

对于f(x)幂为奇数的部分$3x^5 + x^3 + 3x$，它可以看作：

$x(3x^4 + x^2 + 3) = x*odd(x^2)$
其中
$odd(x) = 3x^2 + x + 3$.

所以f(x)用多项式event、odd重构为
$f(x) = even(x^2) + x*odd(x^2)$

这个过程我们这里简称为“**奇偶分解**”。理解这个过程，是理解FFT的另一关键。

注意到，如果我们知道每个输入值x对应的幂$x^2$，构成了一个容积为2的循环子群，如果我们分别知道even和odd在这个折半循环子群上的解，就可以将结果归并出来，得到最终f(x)在每个x的取值。

有了对输入的"求幂分解"，和对多项式的"奇偶分解"，我们就可以对问题进一步分解下去。这里画了一张图来整理一下，图中每个节点的输入，均由上一个节点输入“求幂分解”得来，图中每个节点的多项式，则由上一个节点的多项式“奇偶分解”得来：

![](https://i.imgur.com/yPxQh5t.jpg)


我们按照自底向上的方式求值。

对于最底层的情况，将$8^0$也就是1，分别带入各个多项式，得到的结果为（注意一切计算结果需要模13）：
- $7*1 + 6 = 13 = 0$
- $2$
- $3*1 + 3 = 6$
- $1$

我们利用最底层的计算结果，来计算倒数第二层的多项式计算结果：
- $7x^2 + 2x +6 = even(x^2) + x*odd(x^2)$，那么
    - 若$x=8^0$，那么该多项式结果为$even(8^0) + 8^0*odd(8^0) = 0 + 8^0 * 2 = 2$
    - 若$x=8^2$,那么该多项式结果为$even(8^4) + 8^2*odd(8^4) = even(8^0) + 8^2*odd(8^0)=0 + 8^2*2 = 11$

- $3x^2 + x + 3 = even(x^2) + x*odd(x^2)$，那么
    - 若$x=8^0$，那么该多项式结果为$even(8^0) + 8^0*odd(8^0) = 6 + 8^0 * 1 = 7$
    - 若$x=8^2$,那么该多项式结果为$even(8^4) + 8^2*odd(8^4) = even(8^0) + 8^2*odd(8^0) = 6 + 8^2*1 = 5$

最后，我们来计算顶层的结果：
- $3*x^5 + 7*x^4 + x^3 + 2*x^2 + 3*x + 6 = even(x^2) + x*odd(x^2)$，那么
    - 若$x=8^0$，那么该多项式结果为$even(8^0) + 8^0*odd(8^0) =  2 + 8^0*7 = 9$
    - 若$x=8^1$,那么该多项式结果为$even(8^2) + 8^1*odd(8^2) = 11 + 8^1*5 = 12$
    - 若$x=8^2$，那么该多项式结果为$even(8^4) + 8^2*odd(8^4) = even(8^0) + 8^2*odd(8^0) = 2 + 8^2*7 = 8$
    - 若$x=8^3$,那么该多项式结果为$even(8^6) + 8^3*odd(8^6) = even(8^2) + 8^3*odd(8^2) = 11 + 8^3*5 = 10$

我们把上述计算结果也整理一下，红色标记为输出：

![](https://i.imgur.com/h2UZXfR.jpg)

这个过程和归并排序很像，它们都遵循这样一个模式（源自[V神的文章](https://vitalik.ca/general/2019/05/12/fft.html)）：

![](https://vitalik.ca/images/fft-files/sorting.png)

### FFT总结
FFT用于求解这么一个问题：给定一个某个域上的多项式f(x)，还有一组输入D(也就是横坐标)，求这组输入对应的纵坐标。其中输入D必须是阶为2的某个幂的循环子群。

我们将问题的两个部分进行分解：
- 对于输入D，通过“求幂分解”，得到阶折半的循环子群
- 对于多项式f(x)，通过“奇偶分解”，得到两个子多项式

分别求解两个子问题，再对结果进行归并，所得的时间复杂度就是O(NlogN)，因为相当于每一行都操作了N个元素，总共有logN行。



## 参考链接
- FFT: https://vitalik.ca/general/2019/05/12/fft.html
- stark课程介绍：https://aszepieniec.github.io/stark-anatomy/
- stark 科普：https://mp.weixin.qq.com/s/OrSNhNUncnzh7_bmvRpkbw
- dydx: https://mp.weixin.qq.com/s/Jnm7eOunGyaiGVMPBzz70g